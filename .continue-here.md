# Multi-API Mode Implementation â€” Continuation State

## OVERALL STATUS: 10 of 14 items in progress, web/app.js partially done

## COMPLETED ITEMS (DO NOT RE-DO):

1. core/api.js â€” Full 4-mode rewrite done
2. core/index.js â€” Re-exports updated (fetchModels, API_MODES, DEFAULT_API_PATHS, detectApiMode)
3. package.json â€” Added apiMode (enum with 4 values), apiHost (string), apiPath (string) to settings
4. extension.js â€” FULLY DONE (getConfig reads new fields, configureApi handlers for test/save/reset/fetchModels, getConfigHtml() completely rewritten with mode dropdown + host/path + fetch button). Syntax verified.
5. browser/shared/api.js â€” 4-mode rewrite done (fetch-based), exports Api object with API_MODES, DEFAULT_API_PATHS, detectApiMode, fetchModels
6. browser/background/service-worker.js â€” getEffectiveConfig() builds baseUrl from apiHost+apiPath, passes apiMode
7. browser/options/options.html â€” Mode dropdown + Host/Path + fetch button added
8. browser/options/options.css â€” .form-row, .form-select, .form-group--host/--path, .models-list, .model-chip styles
9. browser/options/options.js â€” All handlers updated (getFormValues, handleSave, handleTest, handleFetchModels, renderModelsList)

## IN PROGRESS:

10. web/app.js (~2429 lines) â€” PARTIALLY DONE:
    - âœ… getEffectiveConfig() updated (adds apiMode, builds baseUrl from apiHost+apiPath)
    - ðŸ”² NEED TO ADD near line 780-790 (before callApiOnce): API_MODES, DEFAULT_API_PATHS constants + detectApiMode() function
    - ðŸ”² callApiOnce() (~line 800-960) â€” needs 4-mode support. Currently only openai + openai-responses (isResponsesApi flag). Need to replace with mode-based branching for URL/headers/body/response parsing. Add claude and gemini modes.
    - ðŸ”² testApiConfig() (~line 966) â€” needs to pass config.apiMode to callApiOnce
    - ðŸ”² NEW fetchModels() function â€” add after testApiConfig. Same logic as browser/shared/api.js.
    - ðŸ”² Settings HTML: The settings tab is built via buildSettingsTab() function. Need to find where #setting-base-url is defined and replace with:
      - API Mode <select> with 5 options (auto, openai, responses, claude, gemini)
      - API Host <input>
      - API Path <input>
      - Fetch models button next to model input
    - ðŸ”² bindSettingsEvents() (~line 1476) â€” add: mode change â†’ auto-fill path from DEFAULT_API_PATHS, fetch models button click handler
    - ðŸ”² populateSettings() (~line 1693) â€” populate apiMode/apiHost/apiPath/apiKey/model from config
    - ðŸ”² Settings save handler: save apiMode/apiHost/apiPath (construct baseUrl), currently saves {baseUrl, apiKey, model}

## REMAINING:

11. intellij/src/main/kotlin/.../core/ApiClient.kt (571 lines) â€” 4-mode callApiOnce + fetchModels
12. intellij/src/main/kotlin/.../settings/EasyPromptSettings.kt â€” apiMode, apiHost, apiPath fields in State class
13. intellij/src/main/kotlin/.../settings/EasyPromptConfigurable.kt â€” mode dropdown + host/path + fetch UI
14. Final syntax/compile verification: node --check for JS files, cd intellij && ./gradlew compileKotlin

## KEY PATTERNS FOR 4 API MODES:

- openai: POST {base}/chat/completions, Authorization: Bearer, body {model,messages,temperature,max_tokens}, choices[0].message.content
- openai-responses: POST {base}/responses, Authorization: Bearer, body {model,instructions,input,temperature,max_output_tokens}, output[type=message].content[type=output_text].text
- claude: POST {base}/messages, x-api-key + anthropic-version:2023-06-01, body {model,system,messages:[{role:user,content}],max_tokens,temperature}, content[0].text
- gemini: POST {base}/models/{model}:generateContent?key={apiKey}, NO auth header, body {contents:[{role:user,parts:[{text}]}],systemInstruction:{parts:[{text}]},generationConfig:{temperature,maxOutputTokens}}, candidates[0].content.parts[0].text

## CONSTANTS:

- API_MODES = {openai:"OpenAI Chat Completions", "openai-responses":"OpenAI Responses API", claude:"Claude API", gemini:"Google Gemini API"}
- DEFAULT_API_PATHS = {openai:"/v1/chat/completions", "openai-responses":"/v1/responses", claude:"/v1/messages", gemini:"/v1beta"}
- detectApiMode(url): /responsesâ†’openai-responses, /v1/messagesâ†’claude, /v1beta|v1alphaâ†’gemini, elseâ†’openai
